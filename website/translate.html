<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Translate D&D Beyond Kit</title>
  <link rel="shortcut icon" href="favicon.png" type="image/x-icon">
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      background-color: #f4f4f9;
      color: #333;
    }

    header {
      background-color: #6200ea;
      color: #fff;
      padding: 1em;
      text-align: center;
    }

    main {
      padding: 0.5em 2em 2em 2em;
    }

    select,
    button {
      padding: 0.5em;
      margin: 0.5em 0;
      font-size: 1em;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1em;
      table-layout: fixed;
    }

    table,
    th,
    td {
      border: 1px solid #ddd;
    }

    th,
    td {
      padding: 0.5em;
      text-align: left;
    }

    th {
      background-color: #6200ea;
      color: white;
      user-select: none;
    }

    th.resizable {
      position: relative;
    }

    th.resizable:nth-child(1) {
      cursor: col-resize;
    }

    th.resizable::after {
      content: "";
      position: absolute;
      right: 0;
      top: 0;
      bottom: 0;
      width: 5px;
    }

    textarea {
      width: 100%;
      padding: 0.5em;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 1em;
      box-sizing: border-box;
      resize: none;
      overflow: hidden;
      min-height: 30px;
    }

    input {
      padding: 0.5em;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 1em;
      box-sizing: border-box;
      resize: none;
      overflow: hidden;
      min-height: 30px;
      margin-bottom: 10px;
    }

    textarea:focus,
    input:focus {
      outline: none;
      border-color: #6200ea;
      box-shadow: 0 0 3px #6200ea;
    }

    .status-complete {
      background-color: #9de19f;
    }

    .status-incomplete {
      background-color: #f09098;
    }

    .translations-area {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .step-by-step {
      text-align: center;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .step-by-step p {
      font-weight: bold;
      color: #5600cf;
      transition: color ease 0.3s;
      cursor: pointer;
    }

    .step-by-step p:hover {
      color: #9430ff;
    }

    .popup {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 50%;
      padding: 20px;
      background-color: white;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
      z-index: 100;
      line-height: 130%;
    }

    .popup h2 {
      text-align: center;
    }

    .popup .close-area {
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .popup button {
      padding: 10px 20px;
      background-color: #6200ea;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }

    #overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      display: none;
    }

    #floatingButton {
      position: fixed;
      bottom: 20px;
      right: 20px;
      border-radius: 30px;
      background-color: #6200ea;
      color: white;
      padding: 10px 20px;
      cursor: pointer;
      z-index: 1000;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
      transition: all ease .3s;
    }

    #floatingButton:hover {
      background-color: #791aff;
      transform: translate(0, -3px);
    }
  </style>
</head>

<body>
  <header>
    <h1 id="headerTitle">Translate D&D Beyond Kit</h1>
  </header>

  <main>

    <div class="step-by-step">
      <p><span id="instructions">Instruções de tradução</span> &#9432;</p>
    </div>

    <div class="translations-area">
      <div><label for="languageSelect" id="contentLanguageLabel">Choose Content Language:</label>
        <select id="languageSelect"></select>

        <!-- <button id="newLanguage">Create New Language</button> -->
      </div>

      <div>
        <label for="uiLanguageSelect" id="uiLanguageLabel">Interface Language:</label>
        <select id="uiLanguageSelect"></select>
      </div>
    </div>

    <table>
      <thead>
        <tr>
          <th class="resizable" style="width: 25%;" id="defaultTextColumn">Default Text</th>
          <th class="resizable"><span id="translationColumn">Translation</span>&nbsp;<span
              id="translationCompletude"></span>
          </th>
          <th style="width: 10%;" id="statusColumn">Status</th>
        </tr>
      </thead>
      <tbody id="translationTable">
        <!-- Dynamically populated -->
      </tbody>
    </table>

    <div id="floatingButton">
      Save
    </div>

    <div id="fullInstructions" class="popup">
      <!-- Filled dynamically based on current language -->
    </div>
    <div id="sendTranslations" class="popup" style="text-align: center;">
      <!-- Filled dynamically based on current language -->
    </div>
    <div id="overlay" onclick="closePopUp()"></div>

  </main>

  <script>
    const uiTranslations = {
      "en": {
        languageName: "English",
        headerTitle: "Translate D&D Beyond Kit",
        uiLanguageLabel: "Interface Language:",
        contentLanguageLabel: "Language to translate:",
        defaultTextColumn: "Default Text (English)",
        translationColumn: "Translation",
        statusColumn: "Status",
        newLanguageButton: "Add New Language",
        complete: "Complete",
        incomplete: "Incomplete",
        save: "Save",
        instructions: "Instructions for translation",
        instructionsLong: `<h2>Translation Instructions</h2><div><strong>Page Editing Structure:</strong><ul><li>Choose the <strong>language to be translated</strong> in the top left corner.</li><li>Choose the <strong>interface language</strong> in the top right corner.</li><li>Table: <ul><li><strong>Standard Text</strong>: Original text in English</li><li><strong>Translation</strong>: Translation in the chosen language and the translation completeness percentage</li><li><strong>Status</strong>: Indicates if there is already a translation</li></ul></li></ul></div><div><strong>How to use:</strong><ul><li>Fill in the fields of the "Translation" column with the respective translation for the chosen language.</li><li>Once you have finished the translations/edits you want to make, click the "Save" button at the bottom right corner.</li><li>After clicking the button, fill in your name and email (optional, if you want credits on the extension page).</li><li>Finally, click "Submit Translations." We will receive them and include them in the extension as soon as possible.</li></ul></div><div class="close-area"><button onclick="closePopUp()">Close</button></div>`,
        sendForm: `<h2>Send Translations</h2><p>The information below is optional. If provided, we will add your translation credits to the extension’s page.</p><label for="name">Name (Optional): </label><input type="text" id="name" name="name"><br><label for="email">E-mail (Optional): </label><input type="email" id="email" name="email"><br><button onclick="sendTranslations()" style="margin-top: 20px;">Send Translations</button>`,
      },
      "pt": {
        languageName: "Português",
        headerTitle: "Traduzir D&D Beyond Kit",
        uiLanguageLabel: "Idioma da Interface:",
        contentLanguageLabel: "Idioma para tradução:",
        defaultTextColumn: "Texto Padrão (Inglês)",
        translationColumn: "Tradução",
        statusColumn: "Status",
        newLanguageButton: "Adicionar Novo Idioma",
        complete: "Completo",
        incomplete: "Incompleto",
        save: "Salvar",
        instructions: "Instruções de tradução",
        instructionsLong: `<h2>Instruções de Tradução</h2><div><strong>Estrutura da página de edição:</strong><ul><li>Escolha do <strong>idioma a ser traduzido</strong> no canto superior esquerdo.</li><li>Escolha do <strong>idioma da interface</strong> no canto superior direito.</li><li>Tabela:<ul><li><strong>Texto padrão</strong>: Texto original no Inglês</li><li><strong>Tradução</strong>: Tradução no idioma escolhido e a porcentagem de completude das traduções</li><li><strong>Status</strong>: Indica se já existe uma tradução</li></ul></li></ul></div><div><strong>Como utilizar:</strong><ul><li>Preencha os campos da coluna "Tradução" com a respectiva tradução para o idioma escolhido.</li><li>Ao finalizar as traduções/edições que gostaria de fazer, clique no botão "Salvar" no canto inferior direito.</li><li>Após clicar no botão, preencha seu nome e e-mail (opcionais, caso queira créditos na página da extensão).</li><li>Por fim, clique em "Enviar traduções". Nós vamos recebê-las e incluir na extensão o quanto antes possível.</li></ul></div><div class="close-area"><button onclick="closePopUp()">Fechar</button></div>`,
        sendForm: `<h2>Enviar traduções</h2><p>Os dados a baixo são opcionais. Se forem informados, vamos adicionar seus créditos da tradução na página da extensão.</p><label for="name">Nome (Opcional): </label><input type="text" id="name" name="name"><br><label for="email">E-mail (Opcional): </label><input type="email" id="email" name="email"><br><button onclick="sendTranslations()" style="margin-top: 20px;">Enviar Traduções</button>`,
      },
      "fr": {
        languageName: "Français",
        headerTitle: "Traduire le D&D Beyond Kit",
        uiLanguageLabel: "Langue de l'interface :",
        contentLanguageLabel: "Langue à traduire :",
        defaultTextColumn: "Texte par défaut (Anglais)",
        translationColumn: "Traduction",
        statusColumn: "Statut",
        newLanguageButton: "Ajouter une nouvelle langue",
        complete: "Complet",
        incomplete: "Incomplet",
        save: "Sauvegarder",
        instructions: "Instructions pour la traduction",
        instructionsLong: `<h2>Instructions de Traduction</h2><div><strong>Structure de la page d'édition :</strong><ul><li>Choisissez la <strong>langue à traduire</strong> en haut à gauche.</li><li>Choisissez la <strong>langue de l'interface</strong> en haut à droite.</li><li>Tableau : <ul><li><strong>Texte standard</strong> : Texte original en anglais</li><li><strong>Traduction</strong> : Traduction dans la langue choisie et le pourcentage de complétion des traductions</li><li><strong>Statut</strong> : Indique si une traduction existe déjà</li></ul></li></ul></div><div><strong>Comment utiliser :</strong><ul><li>Remplissez les champs de la colonne "Traduction" avec la traduction respective pour la langue choisie.</li><li>Lorsque vous avez terminé les traductions/éditions que vous souhaitez effectuer, cliquez sur le bouton "Enregistrer" en bas à droite.</li><li>Après avoir cliqué sur le bouton, remplissez votre nom et votre email (optionnels, si vous souhaitez des crédits sur la page de l'extension).</li><li>Enfin, cliquez sur "Soumettre les traductions". Nous les recevrons et les inclurons dans l'extension dès que possible.</li></ul></div><div class="close-area"><button onclick="closePopUp()">Fermer</button></div>`,
        sendForm: `<h2>Envoyer des traductions</h2><p>Les informations ci-dessous sont facultatives. Si elles sont fournies, nous ajouterons vos crédits de traduction à la page de l'extension.</p><label for="name">Nom (Optionnel) :</label><input type="text" id="name" name="name"><br><label for="email">E-mail (Optionnel) :</label><input type="email" id="email" name="email"><br><button onclick="sendTranslations()" style="margin-top: 20px;">Envoyer les traductions</button>`,
      },
      "it": {
        languageName: "Italiano",
        headerTitle: "Traduci D&D Beyond Kit",
        uiLanguageLabel: "Lingua dell'interfaccia:",
        contentLanguageLabel: "Lingua da tradurre:",
        defaultTextColumn: "Testo di default (Inglese)",
        translationColumn: "Traduzione",
        statusColumn: "Stato",
        newLanguageButton: "Aggiungi Nuova Lingua",
        complete: "Completo",
        incomplete: "Incompleto",
        save: "Salva",
        instructions: "Istruzioni per la traduzione",
        instructionsLong: `<h2>Istruzioni di Traduzione</h2><div><strong>Struttura della pagina di modifica:</strong><ul><li>Scegli la <strong>lingua da tradurre</strong> nell'angolo in alto a sinistra.</li><li>Scegli la <strong>lingua dell'interfaccia</strong> nell'angolo in alto a destra.</li><li>Tabella: <ul><li><strong>Testo standard</strong>: Testo originale in inglese</li><li><strong>Traduzione</strong>: Traduzione nella lingua scelta e il percentuale di completezza delle traduzioni</li><li><strong>Stato</strong>: Indica se esiste già una traduzione</li></ul></li></ul></div><div><strong>Come utilizzare:</strong><ul><li>Compila i campi della colonna "Traduzione" con la rispettiva traduzione per la lingua scelta.</li><li>Una volta terminato le traduzioni/modifiche che desideri fare, clicca sul pulsante "Salva" nell'angolo in basso a destra.</li><li>Dopo aver cliccato sul pulsante, compila il tuo nome e email (opzionali, se desideri i crediti nella pagina dell'estensione).</li><li>Infine, clicca su "Invia traduzioni". Le riceveremo e le includeremo nell'estensione il prima possibile.</li></ul></div><div class="close-area"><button onclick="closePopUp()">Chiudi</button></div>`,
        sendForm: `<h2>Invia Traduzioni</h2><p>I dati qui sotto sono facoltativi. Se forniti, aggiungeremo i crediti della tua traduzione alla pagina dell'estensione.</p><label for="name">Nome (Opzionale): </label><input type="text" id="name" name="name"><br><label for="email">E-mail (Opzionale): </label><input type="email" id="email" name="email"><br><button onclick="sendTranslations()" style="margin-top: 20px;">Invia Traduzioni</button>`,
      },
      "es": {
        languageName: "Español",
        headerTitle: "Traducir D&D Beyond Kit",
        uiLanguageLabel: "Idioma de la interfaz:",
        contentLanguageLabel: "Idioma para traducir:",
        defaultTextColumn: "Texto por defecto (Inglés)",
        translationColumn: "Traducción",
        statusColumn: "Estado",
        newLanguageButton: "Agregar Nuevo Idioma",
        complete: "Completo",
        incomplete: "Incompleto",
        save: "Ahorrar",
        instructions: "Instrucciones para la traducción",
        instructionsLong: `<h2>Instrucciones de Traducción</h2><div><strong>Estructura de la página de edición:</strong><ul><li>Elige el <strong>idioma a traducir</strong> en la esquina superior izquierda.</li><li>Elige el <strong>idioma de la interfaz</strong> en la esquina superior derecha.</li><li>Tabla: <ul><li><strong>Texto estándar</strong>: Texto original en inglés</li><li><strong>Traducción</strong>: Traducción en el idioma elegido y el porcentaje de completitud de las traducciones</li><li><strong>Estado</strong>: Indica si ya existe una traducción</li></ul></li></ul></div><div><strong>Cómo utilizar:</strong><ul><li>Llenar los campos de la columna "Traducción" con la traducción respectiva para el idioma elegido.</li><li>Al finalizar las traducciones/ediciones que deseas hacer, haz clic en el botón "Guardar" en la esquina inferior derecha.</li><li>Después de hacer clic en el botón, completa tu nombre y correo electrónico (opcional, si deseas créditos en la página de la extensión).</li><li>Finalmente, haz clic en "Enviar traducciones". Las recibiremos e incluiremos en la extensión lo antes posible.</li></ul></div><div class="close-area"><button onclick="closePopUp()">Cerrar</button></div>`,
        sendForm: `<h2>Enviar Traducciones</h2><p>Los datos a continuación son opcionales. Si se proporcionan, añadiremos tus créditos de traducción a la página de la extensión.</p><label for="name">Nombre (Opcional): </label><input type="text" id="name" name="name"><br><label for="email">Correo electrónico (Opcional): </label><input type="email" id="email" name="email"><br><button onclick="sendTranslations()" style="margin-top: 20px;">Enviar Traducciones</button>`,
      },
      "de": {
        languageName: "Deutsch",
        headerTitle: "Übersetzen des D&D Beyond Kit",
        uiLanguageLabel: "Schnittstellensprache:",
        contentLanguageLabel: "Sprache zu übersetzen:",
        defaultTextColumn: "Standardtext (Englisch)",
        translationColumn: "Übersetzung",
        statusColumn: "Status",
        newLanguageButton: "Neue Sprache hinzufügen",
        complete: "Vervollständigt",
        incomplete: "Unvollständig",
        save: "Speichern",
        instructions: "Anleitung zur Übersetzung",
        instructionsLong: `<h2>Übersetzungsanweisungen</h2><div><strong>Aufbau der Bearbeitungsseite:</strong><ul><li>Wählen Sie die <strong>Sprache, die übersetzt werden soll</strong>, in der oberen linken Ecke.</li><li>Wählen Sie die <strong>Sprache der Benutzeroberfläche</strong> in der oberen rechten Ecke.</li><li>Tabelle: <ul><li><strong>Standardtext</strong>: Originaltext auf Englisch</li><li><strong>Übersetzung</strong>: Übersetzung in die gewählte Sprache und der Prozentsatz der Abschlussrate der Übersetzungen</li><li><strong>Status</strong>: Gibt an, ob es bereits eine Übersetzung gibt</li></ul></li></ul></div><div><strong>So verwenden Sie es:</strong><ul><li>Füllen Sie die Felder der Spalte "Übersetzung" mit der jeweiligen Übersetzung in die gewählte Sprache aus.</li><li>Wenn Sie die gewünschten Übersetzungen/Änderungen abgeschlossen haben, klicken Sie auf die Schaltfläche "Speichern" in der unteren rechten Ecke.</li><li>Nach dem Klicken auf die Schaltfläche, füllen Sie Ihren Namen und Ihre E-Mail-Adresse aus (optional, wenn Sie Credits auf der Erweiterungsseite möchten).</li><li>Schließlich klicken Sie auf "Übersetzungen einreichen". Wir erhalten sie und fügen sie so schnell wie möglich zur Erweiterung hinzu.</li></ul></div><div class="close-area"><button onclick="closePopUp()">Schließen</button></div>`,
        sendForm: `<h2>Übersetzungen senden</h2><p>Die unten stehenden Daten sind optional. Wenn sie bereitgestellt werden, fügen wir Ihre Übersetzungs-Credits zur Erweiterungsseite hinzu.</p><label for="name">Name (Optional): </label><input type="text" id="name" name="name"><br><label for="email">E-Mail (Optional): </label><input type="email" id="email" name="email"><br><button onclick="sendTranslations()" style="margin-top: 20px;">Übersetzungen senden</button>`,
      },
      "cz": {
        languageName: "Čeština",
        headerTitle: "Přeložit D&D Beyond Kit",
        uiLanguageLabel: "Jazyk rozhraní:",
        contentLanguageLabel: "Jazyk k překladu:",
        defaultTextColumn: "Výchozí text (anglicky)",
        translationColumn: "Překlad",
        statusColumn: "Status",
        newLanguageButton: "Přidat nový jazyk",
        complete: "Dokončeno",
        incomplete: "Nedokončeno",
        save: "Uložit",
        instructions: "Návod k překladu",
        instructionsLong: `<h2>Pokyny pro překlad</h2><div><strong>Struktura editační stránky:</strong><ul><li>Vyberte <strong>jazyk, který chcete přeložit</strong>, v levém horním rohu.</li><li>Vyberte <strong>jazyk rozhraní</strong> v pravém horním rohu.</li><li>Tabulka: <ul><li><strong>Standardní text</strong>: Původní text v angličtině</li><li><strong>Překlad</strong>: Překlad do zvoleného jazyka a procento úplnosti překladů</li><li><strong>Status</strong>: Indikuje, zda již existuje překlad</li></ul></li></ul></div><div><strong>Jak používat:</strong><ul><li>Vyplňte pole sloupce "Překlad" s odpovídajícím překladem do zvoleného jazyka.</li><li>Po dokončení překladů/úprav, které chcete provést, klikněte na tlačítko "Uložit" v pravém dolním rohu.</li><li>Po kliknutí na tlačítko vyplňte své jméno a e-mail (volitelné, pokud chcete získat kredity na stránce rozšíření).</li><li>Nakonec klikněte na "Odeslat překlady". Dostaneme je a co nejdříve je přidáme do rozšíření.</li></ul></div><div class="close-area"><button onclick="closePopUp()">Zavřít</button></div>`,
        sendForm: `<h2>Odeslat překlady</h2><p>Níže uvedené údaje jsou volitelné. Pokud budou poskytnuty, přidáme vaše překladatelské kredity na stránku rozšíření.</p><label for="name">Jméno (volitelné): </label><input type="text" id="name" name="name"><br><label for="email">E-mail (volitelné): </label><input type="email" id="email" name="email"><br><button onclick="sendTranslations()" style="margin-top: 20px;">Odeslat překlady</button>`,
      }
    };

    const baseGithubTranslationLink = "https://raw.githubusercontent.com/hotaydev/dnd-beyond-kit/refs/heads/main/translations";
    const defaultTextsForTranslation = `${baseGithubTranslationLink}/base.json`;

    const translations = {
      'pt-br': {
        name: "Portuguese (Português)",
        main: `${baseGithubTranslationLink}/pt-br.json`,
        spells: `${baseGithubTranslationLink}/spells/pt-br.json`
      },
      'cs-cz': {
        name: "Czech (Čeština)",
        main: `${baseGithubTranslationLink}/cs-cz.json`,
        spells: `${baseGithubTranslationLink}/spells/cs-cz.json`
      },
      'it-it': {
        name: "Italian (Italiano)",
        main: `${baseGithubTranslationLink}/it-it.json`,
        spells: `${baseGithubTranslationLink}/spells/it-it.json`
      },
      'fr-fr': {
        name: "French (Français)",
        main: `${baseGithubTranslationLink}/fr-fr.json`,
        spells: `${baseGithubTranslationLink}/spells/fr-fr.json`
      },
      'es-es': {
        name: "Spanish (Español)",
        main: `${baseGithubTranslationLink}/es-es.json`,
        spells: `${baseGithubTranslationLink}/spells/es-es.json`
      },
      'de-de': {
        name: "German (Deutsch)",
        main: `${baseGithubTranslationLink}/de-de.json`,
        spells: `${baseGithubTranslationLink}/spells/de-de.json`
      },
    };

    const languageSelect = document.getElementById("languageSelect");
    const translationTable = document.getElementById("translationTable");
    const uiLanguageSelect = document.getElementById("uiLanguageSelect");

    const populateLanguageOptions = () => {
      for (const lang in translations) {
        const option = document.createElement("option");
        option.value = lang;
        option.textContent = translations[lang].name;
        languageSelect.appendChild(option);
      }
    };

    const populateUILanguageOptions = () => {
      for (const lang in uiTranslations) {
        const option = document.createElement("option");
        option.value = lang;
        option.textContent = uiTranslations[lang].languageName;
        uiLanguageSelect.appendChild(option);
      }
    };

    const loadTranslations = async (language) => {
      try {
        const [defaultDataArray, translatedData] = await Promise.all([
          fetch(defaultTextsForTranslation).then(res => res.json()),
          fetch(translations[language].main).then(res => res.json())
        ]);

        const defaultData = Object.fromEntries(
          defaultDataArray.map(text => [text.toLowerCase(), text])
        );

        renderTranslationTable(defaultData, translatedData);
      } catch (error) {
        console.error("Error loading translations: ", error);
      }
    };

    const renderTranslationTable = (defaultData, translatedData) => {
      translationTable.innerHTML = "";

      const defaultDataKeys = Object.keys(defaultData);
      const uniqueData = defaultDataKeys.filter((a, b) => defaultDataKeys.indexOf(a) === b);

      const rows = uniqueData.map(key => {
        const row = document.createElement("tr");

        const defaultTextCell = document.createElement("td");
        defaultTextCell.textContent = defaultData[key];
        row.appendChild(defaultTextCell);

        const translationCell = document.createElement("td");
        const textarea = document.createElement("textarea");
        textarea.value = translatedData[key] || "";

        // Auto-resize textarea based on content
        textarea.style.height = "auto";
        textarea.style.height = textarea.scrollHeight + "px";

        textarea.addEventListener("input", (e) => {
          e.target.style.height = "auto";
          e.target.style.height = e.target.scrollHeight + "px";
        });

        translationCell.appendChild(textarea);
        row.appendChild(translationCell);

        const statusCell = document.createElement("td");
        statusCell.textContent = translatedData[key] ? "Complete" : "Incomplete";
        statusCell.classList.add(translatedData[key] ? "status-complete" : "status-incomplete");
        row.appendChild(statusCell);

        return { row, isComplete: !!translatedData[key] };
      });

      rows.sort((a, b) => b.isComplete - a.isComplete);
      rows.forEach(({ row }) => translationTable.appendChild(row));

      const translatedRows = rows.filter(({ isComplete }) => isComplete).length;
      const percentageDone = ((translatedRows * 100) / rows.length).toFixed(2);

      document.getElementById("translationCompletude").textContent = `(${percentageDone}%)`;

      const lastUsedlang = localStorage.getItem('uiLanguage');
      uiLanguageSelect.value = lastUsedlang ?? "en";
      translateUI(lastUsedlang ?? "en");
    };

    const handleLanguageChange = () => {
      const selectedLanguage = languageSelect.value;
      localStorage.setItem('editingLanguage', selectedLanguage);
      loadTranslations(selectedLanguage);
    };

    languageSelect.addEventListener("change", handleLanguageChange);

    populateLanguageOptions();
    populateUILanguageOptions();

    // Automatically load the first language on page load
    document.addEventListener("DOMContentLoaded", () => {
      const lastEditedlang = localStorage.getItem('editingLanguage');
      const firstLanguage = Object.keys(translations)[0];

      if (lastEditedlang) {
        languageSelect.value = lastEditedlang;
        loadTranslations(lastEditedlang);
      } else if (firstLanguage) {
        languageSelect.value = firstLanguage;
        loadTranslations(firstLanguage);
      }
    });

    const translateUI = (language) => {
      const translations = uiTranslations[language];
      document.getElementById("headerTitle").textContent = translations.headerTitle;
      document.getElementById("uiLanguageLabel").textContent = translations.uiLanguageLabel;
      document.getElementById("contentLanguageLabel").textContent = translations.contentLanguageLabel;
      document.getElementById("defaultTextColumn").textContent = translations.defaultTextColumn;
      document.getElementById("translationColumn").textContent = translations.translationColumn;
      document.getElementById("instructions").textContent = translations.instructions;
      document.getElementById("fullInstructions").innerHTML = translations.instructionsLong;
      document.getElementById("sendTranslations").innerHTML = translations.sendForm;
      document.getElementById("statusColumn").textContent = translations.statusColumn;
      document.getElementById("floatingButton").textContent = translations.save;
      // document.getElementById("newLanguage").textContent = translations.newLanguageButton;
      document.querySelectorAll(".status-complete").forEach(element => element.textContent = translations.complete);
      document.querySelectorAll(".status-incomplete").forEach(element => element.textContent = translations.incomplete);
    };

    uiLanguageSelect.addEventListener("change", (e) => {
      localStorage.setItem('uiLanguage', e.target.value);
      translateUI(e.target.value);
    });

    // Make the first column resizable
    const firstHeader = document.querySelector("th.resizable:first-of-type");
    let startX, startWidth, minWidth = 100;

    const onMouseMove = (e) => {
      const width = Math.max(minWidth, startWidth + (e.clientX - startX));
      firstHeader.style.width = `${width}px`;
      document.querySelector("th.resizable:nth-of-type(2)").style.width = `calc(100% - ${width}px - 200px)`; // Adjust the second column
    };

    const onMouseUp = () => {
      document.removeEventListener("mousemove", onMouseMove);
      document.removeEventListener("mouseup", onMouseUp);
    };

    firstHeader.addEventListener("mousedown", (e) => {
      startX = e.clientX;
      startWidth = firstHeader.offsetWidth;
      document.addEventListener("mousemove", onMouseMove);
      document.addEventListener("mouseup", onMouseUp);
    });

    document.querySelector('.step-by-step p').addEventListener('click', function () {
      document.getElementById('fullInstructions').style.display = 'block';
      document.getElementById('overlay').style.display = 'block';
    });

    document.getElementById('floatingButton').addEventListener('click', function () {
      document.getElementById('sendTranslations').style.display = 'block';
      document.getElementById('overlay').style.display = 'block';
    });

    function closePopUp() {
      document.getElementById('fullInstructions').style.display = 'none';
      document.getElementById('sendTranslations').style.display = 'none';
      document.getElementById('overlay').style.display = 'none';
    }

    function sendTranslations() {
      const user = document.querySelector('input[name="name"]').value;
      const email = document.querySelector('input[name="email"]').value;
      const finalEditedTranslations = {};

      document.querySelectorAll('tbody tr').forEach((row) => {
        const td = row.querySelectorAll('td');
        const key = td[0].textContent.toLowerCase();
        const value = td[1].querySelector('textarea').value;

        if (value.trim() === '') return;

        finalEditedTranslations[key] = value;
      });

      const finalObject = {
        user,
        email,
        translations: finalEditedTranslations,
        lang: languageSelect.value,
      };

      closePopUp();

      // TODO: Improve message to show a success/error toast
      fetch('https://n8n.hotay.dev/webhook/dnd-beyond-kit-translation', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(finalObject),
      }).then(response => {
        alert("Translations sent successfully! Thank you <3");
      }).catch(error => {
        alert("Error sending translations: " + error);
      });
    }
  </script>
</body>

</html>